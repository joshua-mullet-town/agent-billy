#cloud-config
users:
  - name: ubuntu
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICOWn4+jHkJv1qZnX++HA26lDCeKzHAP1UFJkMIxjHAl joshuamullet@Joshuas-MacBook-Air.local
    sudo: ALL=(ALL) NOPASSWD:ALL

packages:
  - curl
  - wget
  - git
  - jq

runcmd:
  - echo "Billy VM created at $(date)" > /home/ubuntu/billy-status.log
  - echo "SSH access ready" >> /home/ubuntu/billy-status.log
  - echo "Installing Node.js and tools..." >> /home/ubuntu/billy-status.log
  - curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
  - sudo apt-get install -y nodejs
  - echo "Setting up coordinator workflow..." >> /home/ubuntu/billy-status.log
  - chown ubuntu:ubuntu /home/ubuntu/coordinator-workflow.sh
  - chmod +x /home/ubuntu/coordinator-workflow.sh
  - echo "Starting coordinator workflow..." >> /home/ubuntu/billy-status.log
  - sudo -u ubuntu nohup /home/ubuntu/coordinator-workflow.sh > /home/ubuntu/coordinator.log 2>&1 &
  - echo "Coordinator workflow started" >> /home/ubuntu/billy-status.log

write_files:
  - path: /home/ubuntu/coordinator-workflow.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      # Billy's Coordinator Workflow - Polls coordinator for step-by-step guidance
      
      VM_ID="vm-1752848700267-givegrove"
      COORDINATOR_URL="https://agent-billy-production.up.railway.app/coordinator/next-step"
      ISSUE_CONTEXT="Issue #1119: Update README.md with setup instructions  troubleshooting"
      ANTHROPIC_API_KEY="***REMOVED***"
      GITHUB_TOKEN="***REMOVED***"
      
      echo "ðŸ¤– Billy Coordinator Workflow Started at $(date)" > /home/ubuntu/coordinator.log
      echo "VM ID: $VM_ID" >> /home/ubuntu/coordinator.log
      echo "Issue: $ISSUE_CONTEXT" >> /home/ubuntu/coordinator.log
      echo "Coordinator: $COORDINATOR_URL" >> /home/ubuntu/coordinator.log
      
      # Install Claude CLI
      echo "ðŸ“¦ Installing Claude CLI..." >> /home/ubuntu/coordinator.log
      npm install -g @anthropic-ai/claude-code
      
      # Install GitHub CLI for PR creation
      echo "ðŸ“¦ Installing GitHub CLI..." >> /home/ubuntu/coordinator.log
      curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
      echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
      sudo apt update && sudo apt install -y gh
      echo "$GITHUB_TOKEN" | gh auth login --with-token
      
      # Clone repository  
      echo "ðŸ“ Cloning repository..." >> /home/ubuntu/coordinator.log
      git clone https://github.com/south-bend-code-works/GiveGrove.git
      cd GiveGrove
      
      # Set up git identity
      git config user.name "Agent Billy"
      git config user.email "agent-billy@givegrove.com"
      
      # Install dependencies for simple projects
      echo "ðŸ“¦ Installing dependencies..." >> /home/ubuntu/coordinator.log
      if [ -f package.json ]; then
        npm install
      fi
      
      # MAIN COORDINATOR POLLING LOOP
      echo "ðŸ”„ Starting coordinator polling loop..." >> /home/ubuntu/coordinator.log
      current_step="initial"
      recent_output="Claude CLI initialized and ready for commands"
      max_iterations=20
      iteration=0
      
      while [ $iteration -lt $max_iterations ]; do
        iteration=$((iteration + 1))
        echo "ðŸ”„ Coordinator Loop Iteration $iteration" >> /home/ubuntu/coordinator.log
        
        # Call coordinator using jq for safe JSON generation
        coordinator_response=$(jq -n \
          --arg vm_id "$VM_ID" \
          --arg issue_context "$ISSUE_CONTEXT" \
          --arg recent_output "$recent_output" \
          --arg current_step "$current_step" \
          '{vm_id: $vm_id, issue_context: $issue_context, recent_output: $recent_output, current_step: $current_step}' | \
          curl -s -X POST "$COORDINATOR_URL" \
            -H "Content-Type: application/json" \
            -d @-)
        
        echo "ðŸ“¡ Coordinator response: $coordinator_response" >> /home/ubuntu/coordinator.log
        
        # Extract next prompt and completion status
        next_prompt=$(echo "$coordinator_response" | jq -r '.next_prompt')
        is_complete=$(echo "$coordinator_response" | jq -r '.complete')
        
        # Check if workflow is complete
        if [ "$is_complete" = "true" ]; then
          echo "ðŸŽ‰ Workflow completed!" >> /home/ubuntu/coordinator.log
          break
        fi
        
        # Feed prompt to Claude CLI
        echo "ðŸ¤– Sending prompt to Claude CLI: $next_prompt" >> /home/ubuntu/coordinator.log
        export ANTHROPIC_API_KEY="$ANTHROPIC_API_KEY"
        recent_output=$(echo "$next_prompt" | claude --print --dangerously-skip-permissions 2>&1)
        
        echo "ðŸ”„ Claude CLI output: $recent_output" >> /home/ubuntu/coordinator.log
        
        # Update current step based on output
        if [[ "$recent_output" == *"updated"* ]] || [[ "$recent_output" == *"implemented"* ]]; then
          current_step="coding_complete"
        elif [[ "$recent_output" == *"test"* ]] && [[ "$recent_output" == *"passed"* ]]; then
          current_step="testing_complete"
        elif [[ "$recent_output" == *"pull request"* ]] || [[ "$recent_output" == *"PR"* ]]; then
          current_step="pr_complete"
        fi
        
        # Wait before next iteration
        sleep 30
      done
      
      echo "ðŸ§¹ Workflow complete. VM will self-destruct..." >> /home/ubuntu/coordinator.log